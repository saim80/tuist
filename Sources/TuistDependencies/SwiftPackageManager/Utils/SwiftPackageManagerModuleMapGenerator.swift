import TSCBasic
import TuistSupport

/// The type of modulemap file
public enum ModuleMapType: Equatable {
    /// No headers and hence no modulemap file
    case none
    /// Custom modulemap file provided in SPM package
    case custom
    /// Umbrella header provided in SPM package
    case header
    /// Nested umbrella header provided in SPM package
    case nestedHeader
    /// No umbrella header provided in SPM package, define umbrella directory
    case directory
}

/// Protocol that allows to generate a modulemap for an SPM target.
/// It implements the Swift Package Manager logic
/// [documented here](https://github.com/apple/swift-package-manager/blob/main/Documentation/Usage.md#creating-c-language-targets) and
/// [implemented here](https://github.com/apple/swift-package-manager/blob/main/Sources/PackageLoading/ModuleMapGenerator.swift).
public protocol SwiftPackageManagerModuleMapGenerating {
    func generate(moduleName: String, publicHeadersPath: AbsolutePath) throws -> (type: ModuleMapType, path: AbsolutePath?)
}

public final class SwiftPackageManagerModuleMapGenerator: SwiftPackageManagerModuleMapGenerating {
    public init() {}

    // swiftlint:disable:next function_body_length
    public func generate(moduleName: String, publicHeadersPath: AbsolutePath) throws -> (type: ModuleMapType, path: AbsolutePath?) {
        let moduleMapPath = publicHeadersPath.appending(component: "module.modulemap")
        let umbrellaHeaderPath = publicHeadersPath.appending(component: moduleName + ".h")
        let nestedUmbrellaHeaderPath = publicHeadersPath.appending(component: moduleName).appending(component: moduleName + ".h")

        let moduleMapType: ModuleMapType

        if FileHandler.shared.exists(moduleMapPath) {
            // User defined modulemap exists, use it
            moduleMapType = .custom
        } else if FileHandler.shared.exists(umbrellaHeaderPath) {
            // If 'PublicHeadersDir/ModuleName.h' exists, then use it as the umbrella header.
            moduleMapType = .header
        } else if FileHandler.shared.exists(nestedUmbrellaHeaderPath) {
            // If 'PublicHeadersDir/ModuleName/ModuleName.h' exists, then use it as the umbrella header.
            moduleMapType = .nestedHeader
        } else if FileHandler.shared.exists(publicHeadersPath) {
            // Otherwise, consider the public headers folder as umbrella directory
            moduleMapType = .directory
        } else {
            moduleMapType = .none
        }

        let generatedModuleMapContent: String
        switch moduleMapType {
        case .none:
            return (type: moduleMapType, path: nil)
        case .header:
            // When umbrella header is present, no need to define a modulemap as it is generated by Xcode
            return (type: moduleMapType, path: nil)
        case .custom:
            return (type: moduleMapType, path: moduleMapPath)
        case .nestedHeader:
            generatedModuleMapContent =
                """
                module \(moduleName) {
                    umbrella header "\(nestedUmbrellaHeaderPath.pathString)"
                    export *
                }

                """
        case .directory:
            generatedModuleMapContent =
                """
                module \(moduleName) {
                    umbrella "\(publicHeadersPath.pathString)"
                    export *
                }

                """
        }

        let generatedModuleMapPath = publicHeadersPath.appending(component: "\(moduleName).modulemap")
        try FileHandler.shared.write(generatedModuleMapContent, path: generatedModuleMapPath, atomically: true)
        return (type: moduleMapType, path: generatedModuleMapPath)
    }
}
